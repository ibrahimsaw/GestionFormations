{% load widget_tweaks %}

<form method="post" novalidate>
  {% csrf_token %}

  <!-- Affichage des erreurs globales du formulaire -->
  {% if form.non_field_errors %}
    <div class="alert alert-danger">
      {% for error in form.non_field_errors %}
        <div>⚠️ {{ error }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Statut -->
  <div class="row mb-3">
    <label for="{{ form.statut.id_for_label }}" class="col-sm-2 col-form-label">Statut</label>
    <div class="col-sm-10">
      {{ form.statut|add_class:"form-select" }}
      {% for error in form.statut.errors %}
        <div class="text-danger small">⚠️ {{ error }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- Barre de recherche (par matricule) -->
  <div class="row mb-3">
    <label for="searchEtudiants" class="col-sm-2 col-form-label">Rechercher Étudiant</label>
    <div class="col-sm-10">
      <div class="input-group">
        <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control" id="searchEtudiants" placeholder="Tapez un matricule...">
      </div>
    </div>
  </div>

  <!-- Étudiant (select filtré) -->
  <div class="row mb-3">
    <label for="id_etudiant" class="col-sm-2 col-form-label">Étudiant</label>
    <div class="col-sm-10">
      {{ form.etudiant|add_class:"form-select" }}
      {% for error in form.etudiant.errors %}
        <div class="text-danger small">⚠️ {{ error }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- Année académique -->
  <div class="col-md-4 mb-3">
    <label class="col-sm-12 col-form-label fw-semibold">Année académique</label>
    <div class="col-sm-12">
      <div class="input-group input-group-merge">
        <span class="input-group-text bg-light"><i class="bx bx-calendar-alt"></i></span>
        <select id="id_annee" name="annee_academique" class="form-select">
          {% for value, label in form.annee_academique.field.choices %}
            <option value="{{ value }}" {% if form.annee_academique.value == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      {% if form.annee_academique.errors %}
        <div class="text-danger small mt-1">
          {% for error in form.annee_academique.errors %}
            <div>⚠️ {{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Parcours -->
  <div class="col-md-4 mb-3">
    <label class="col-sm-12 col-form-label fw-semibold">Parcours</label>
    <div class="col-sm-12">
      <div class="input-group input-group-merge">
        <span class="input-group-text bg-light"><i class="bx bx-book"></i></span>
        <select id="id_parcours" name="parcours" class="form-select">
          <option value="">---------</option>
        </select>
      </div>
      {% if form.parcours.errors %}
        <div class="text-danger small mt-1">
          {% for error in form.parcours.errors %}
            <div>⚠️ {{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Classe -->
  <div class="col-md-4 mb-3">
    <label class="col-sm-12 col-form-label fw-semibold">Classe</label>
    <div class="col-sm-12">
      <div class="input-group input-group-merge">
        <span class="input-group-text bg-light"><i class="bx bx-group"></i></span>
        <select id="id_classe" name="classe" class="form-select">
          <option value="">---------</option>
        </select>
      </div>
      {% if form.classe.errors %}
        <div class="text-danger small mt-1">
          {% for error in form.classe.errors %}
            <div>⚠️ {{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Bouton soumettre -->
  <div class="text-center mt-4">
    <button type="submit" class="btn btn-primary">Enregistrer</button>
  </div>
</form>

<!-- JS pour recherche étudiant -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const searchInput = document.getElementById('searchEtudiants');
  const selectEtudiant = document.getElementById('id_etudiant');
  const originalOptions = Array.from(selectEtudiant.options);

  searchInput.addEventListener('input', function () {
    const searchValue = this.value.toLowerCase().trim();
    selectEtudiant.innerHTML = '';

    const filtered = originalOptions.filter(opt =>
      opt.text.toLowerCase().includes(searchValue)
    );

    if (filtered.length === 0) {
      const option = document.createElement('option');
      option.text = '-- Aucun résultat --';
      option.disabled = true;
      selectEtudiant.add(option);
    } else {
      filtered.forEach(option => selectEtudiant.add(option));
    }
  });
});
</script>

<!-- JS pour chargement dynamique des parcours et classes -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const anneeSelect = document.getElementById('id_annee');
  const parcoursSelect = document.getElementById('id_parcours');
  const classeSelect = document.getElementById('id_classe');
  let parcoursData = [];

  function resetSelect(selectElement, placeholder = '---------') {
    selectElement.innerHTML = '';
    const option = document.createElement('option');
    option.value = '';
    option.textContent = placeholder;
    selectElement.appendChild(option);
  }

  anneeSelect.addEventListener('change', function () {
    const anneeId = this.value;
    resetSelect(parcoursSelect);
    resetSelect(classeSelect);

    if (!anneeId) return;

    fetch("{% url 'utilisateur:get_parcours_options' %}?annee_academique=" + anneeId)
      .then(response => response.json())
      .then(data => {
        parcoursData = data;
        data.forEach(parcours => {
          const option = new Option(parcours.nom, parcours.id);
          parcoursSelect.add(option);
        });
      })
      .catch(error => {
        console.error("Erreur lors de la récupération des parcours :", error);
      });
  });

  parcoursSelect.addEventListener('change', function () {
    const parcoursId = this.value;
    resetSelect(classeSelect);

    if (!parcoursId) return;

    const selectedParcours = parcoursData.find(p => p.id == parcoursId);
    if (selectedParcours) {
      selectedParcours.classes.forEach(classe => {
        const option = new Option(classe.nom, classe.id);
        classeSelect.add(option);
      });
    }
  });
});
</script>
