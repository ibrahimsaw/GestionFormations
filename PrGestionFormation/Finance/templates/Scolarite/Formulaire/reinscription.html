{% load widget_tweaks %}
<!-- Barre de recherche (par matricule) -->
<div class="row mb-3">
  <label for="searchEtudiants" class="col-sm-2 col-form-label">Rechercher Étudiant</label>
  <div class="col-sm-10">
    <div class="input-group">
      <span class="input-group-text bg-light"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" id="searchEtudiants" placeholder="Tapez un matricule...">
    </div>
  </div>
</div>

<!-- Étudiant (select filtré) -->
<div class="row mb-3">
  <label for="id_etudiant" class="col-sm-2 col-form-label">Étudiant</label>
  <div class="col-sm-10">
    {{ form.etudiant|add_class:"form-select" }}
    {% for error in form.etudiant.errors %}
      <div class="text-danger small">⚠️ {{ error }}</div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const searchInput = document.getElementById('searchEtudiants');
  const selectEtudiant = document.getElementById('id_etudiant');

  // Sauvegarde originale des options
  const originalOptions = Array.from(selectEtudiant.options);

  searchInput.addEventListener('input', function () {
    const searchValue = this.value.toLowerCase().trim();

    // Efface les options actuelles
    selectEtudiant.innerHTML = '';

    // Remet uniquement les options correspondantes
    const filtered = originalOptions.filter(opt =>
      opt.text.toLowerCase().includes(searchValue)
    );

    // Si aucune correspondance, on met une option vide
    if (filtered.length === 0) {
      const option = document.createElement('option');
      option.text = '-- Aucun résultat --';
      option.disabled = true;
      selectEtudiant.add(option);
    } else {
      filtered.forEach(option => selectEtudiant.add(option));
    }
  });
});
</script>

<!-- Année académique -->
<div class="row mb-3">
  <label for="{{ form.annee_academique.id_for_label }}" class="col-sm-2 col-form-label">Année académique</label>
  <div class="col-sm-10">
    {{ form.annee_academique|add_class:"form-select" }}
    {% for error in form.annee_academique.errors %}
      <div class="text-danger small">⚠️ {{ error }}</div>
    {% endfor %}
  </div>
</div>

<!-- Parcours -->
<div class="row mb-3">
  <label for="{{ form.parcours.id_for_label }}" class="col-sm-2 col-form-label">Parcours</label>
  <div class="col-sm-10">
    {{ form.parcours|add_class:"form-select" }}
    {% for error in form.parcours.errors %}
      <div class="text-danger small">⚠️ {{ error }}</div>
    {% endfor %}
  </div>
</div>

<!-- Classe -->
<div class="row mb-3">
  <label for="{{ form.classe.id_for_label }}" class="col-sm-2 col-form-label">Classe</label>
  <div class="col-sm-10">
    {{ form.classe|add_class:"form-select" }}
    {% for error in form.classe.errors %}
      <div class="text-danger small">⚠️ {{ error }}</div>
    {% endfor %}
  </div>
</div>

<!-- Statut -->
<div class="row mb-3">
  <label for="{{ form.statut.id_for_label }}" class="col-sm-2 col-form-label">Statut</label>
  <div class="col-sm-10">
    {{ form.statut|add_class:"form-select" }}
    {% for error in form.statut.errors %}
      <div class="text-danger small">⚠️ {{ error }}</div>
    {% endfor %}
  </div>
</div>
<script>
$(document).ready(function () {
  $('.select2-matricule').select2({
    placeholder: 'Entrez un matricule...',
    minimumInputLength: 2,
    ajax: {
      url: '{% url "finance:etudiant-search-matricule" %}',
      dataType: 'json',
      delay: 250,
      data: function (params) {
        return {
          q: params.term // terme tapé par l'utilisateur
        };
      },
      processResults: function (data) {
        return {
          results: data.map(function (etu) {
            return {
              id: etu.id,
              text: etu.matricule + " - " + etu.nom
            };
          })
        };
      },
      cache: true
    }
  });
});
</script>
