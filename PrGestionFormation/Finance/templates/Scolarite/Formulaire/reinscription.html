{% load widget_tweaks static %}
{% if formset.non_form_errors %}
  <div class="alert alert-danger">
    <strong>Erreurs g√©n√©rales :</strong>
    <ul>
      {% for error in formset.non_form_errors %}
        <li>‚ùå {{ error }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

  <!-- üìç Statut -->
  <div class="row mb-3">
    <label for="id_statut" class="col-sm-2 col-form-label">Statut</label>
    <div class="col-sm-10">
      {{ form.statut|add_class:"form-select" }}
      {% for error in form.statut.errors %}
        <div class="text-danger small">‚ö†Ô∏è {{ error }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- üîé Recherche √©tudiant -->
  <div class="row mb-3">
    <label for="searchEtudiants" class="col-sm-2 col-form-label">Rechercher un √©tudiant</label>
    <div class="col-sm-10">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" id="searchEtudiants" class="form-control" placeholder="Entrer un matricule...">
      </div>
    </div>
  </div>

  <!-- üë§ √âtudiant -->
  <div class="row mb-3">
    <label for="id_etudiant" class="col-sm-2 col-form-label">√âtudiant</label>
    <div class="col-sm-10">
      {{ form.etudiant|add_class:"form-select select2" }}
      {% for error in form.etudiant.errors %}
        <div class="text-danger small">‚ö†Ô∏è {{ error }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- üéì Ann√©e / Parcours / Classe -->
  <div class="row mb-3" id="annee_parcours_classe">
    <div class="col-md-4">
      <label>Ann√©e acad√©mique</label>
      {{ form.annee_academique|add_class:"form-select" }}
    </div>
    <div class="col-md-4">
      <label>Parcours</label>
      {{ form.parcours|add_class:"form-select" }}
    </div>
    <div class="col-md-4">
      <label>Classe</label>
      {{ form.classe|add_class:"form-select" }}
    </div>
  </div>

  <!-- üìà R√©sultat -->
  <div class="row mb-3" id="resultat_section">
    <label class="col-sm-2 col-form-label">R√©sultat ann√©e pr√©c√©dente</label>
    <div class="col-sm-10">
      {{ form.resultat_annee_precedente|add_class:"form-control" }}
    </div>
  </div>

  <!-- üìù Motif -->
  <div class="row mb-3" id="motif_section">
    <label class="col-sm-2 col-form-label">Motif</label>
    <div class="col-sm-10">
      {{ form.motif|add_class:"form-control" }}
    </div>
  </div>

  <!-- üìÖ Date de l‚Äô√©v√©nement -->
  
<div class="row mb-3" id="evenement_section">
  <label for="id_date_evenement" class="col-sm-2 col-form-label">üìÖ Date de l‚Äô√©v√©nement</label>
  <div class="col-sm-10">
    <div class="input-group input-group-merge">
      <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
      <input type="text"
             id="id_date_evenement"
             name="date_evenement"
             class="form-control"
             value="{{ date|date:'d/m/Y H:i' }}"
             readonly>
    </div>
    {% for error in form.date_evenement.errors %}
      <div class="text-danger small">‚ö†Ô∏è {{ error }}</div>
    {% endfor %}
  </div>
</div>



  <!-- ‚è≥ Dur√©e -->
  <div class="row mb-3" id="duree_section">
    <label class="col-sm-2 col-form-label">Dur√©e (jours)</label>
    <div class="col-sm-10">
      {{ form.duree|add_class:"form-control"|attr:"min=1" }}
    </div>
  </div>

  <!-- üè´ √âtablissement accueil -->
  <div class="row mb-3" id="etablissement_section">
    <label class="col-sm-2 col-form-label">√âtablissement d‚Äôaccueil</label>
    <div class="col-sm-10">
      {{ form.Etablissement_accuiel|add_class:"form-control" }}
    </div>
  </div>

  <!-- üìé Documents -->
  <div class="mb-3" id="documents_section">
    <h5 class="mb-3 fw-semibold">Documents √† fournir</h5>
    {{ formset.management_form }}
    <div id="documents-container"></div>
  </div>

  <template id="document-template">
  <div class="row g-3 mb-3 p-3 border rounded bg-light shadow-sm doc-block" data-doc-type="">
    
    <!-- Type de document (d√©sactiv√©) -->
    <div class="col-md-5">
      <label class="form-label fw-semibold">Type de document</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-file-earmark-text"></i></span>
        <input type="text" class="form-control bg-white" disabled readonly>
        <input type="hidden" name="__prefix__-type_document" value="">
      </div>
    </div>

    <!-- Fichier -->
    <div class="col-md-5">
      <label class="form-label fw-semibold">Fichier</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-upload"></i></span>
        <input type="file" name="__prefix__-fichier" class="form-control" required>
      </div>
    </div>

    <!-- Supprimer -->
    <div class="col-md-2 d-flex align-items-end">
      <button type="button" class="btn btn-outline-danger w-100 remove-document">
        <i class="bi bi-trash"></i> Supprimer
      </button>
    </div>

  </div>
</template>


<script>
document.addEventListener('DOMContentLoaded', () => {
  const statutField = document.getElementById('id_statut');
  const container = document.getElementById('documents-container');
  const totalForms = document.getElementById('id_documents_inscription-TOTAL_FORMS');
  const template = document.getElementById('document-template').content;

  const documentsParStatut = {
    en_attente: ['formulaire', 'naissance', 'cni'],
    reserviste: ['formulaire', 'diplome', 'bulletin'],
    reinscrit: ['formulaire', 'frais'],
    redoublant: ['formulaire']
  };

  const champsParStatut = {
    reinscrit: ['annee_parcours_classe', 'resultat_section', 'documents_section'],
    redoublant: ['annee_parcours_classe', 'resultat_section', 'documents_section'],
    abandon: ['motif_section', 'evenement_section'],
    suspendu: ['motif_section', 'evenement_section', 'duree_section'],
    exclu: ['motif_section', 'evenement_section'],
    en_attente: ['documents_section'],
    reserviste: ['documents_section'],
    transfert: ['etablissement_section', 'motif_section', 'evenement_section'],
    diplome: ['resultat_section']
  };

  const tousLesChamps = [
    'annee_parcours_classe', 'resultat_section', 'motif_section', 'evenement_section',
    'duree_section', 'etablissement_section', 'documents_section'
  ];

  function afficherChamps() {
    tousLesChamps.forEach(id => document.getElementById(id)?.classList.add('d-none'));
    (champsParStatut[statutField.value] || []).forEach(id => document.getElementById(id)?.classList.remove('d-none'));
  }

  function resetDocuments() {
    container.innerHTML = '';
    totalForms.value = 0;
  }

  function addDocument(type_document, index) {
    const clone = template.cloneNode(true);
    clone.querySelector('[name$="-type_document"]').name = `documents_inscription-${index}-type_document`;
    clone.querySelector('[name$="-type_document"]').value = type_document;
    clone.querySelector('[type="text"]').value = type_document.charAt(0).toUpperCase() + type_document.slice(1).replace('_', ' ');
    clone.querySelector('[name$="-fichier"]').name = `documents_inscription-${index}-fichier`;

    clone.querySelector('.remove-document').addEventListener('click', function () {
      this.closest('.doc-block').remove();
      updateTotalForms();
    });

    container.appendChild(clone);
    updateTotalForms();
  }

  function updateTotalForms() {
    totalForms.value = container.querySelectorAll('.doc-block').length;
  }

  function updateDocumentsForStatut() {
    const statut = statutField.value;
    const docs = documentsParStatut[statut] || [];
    resetDocuments();
    docs.forEach((type, i) => addDocument(type, i));
  }

  document.getElementById('searchEtudiants').addEventListener('input', function () {
    const input = this.value.toLowerCase();
    const select = document.getElementById('id_etudiant');
    const options = Array.from(select.options);
    select.innerHTML = '';
    const filtered = options.filter(opt => opt.text.toLowerCase().includes(input));
    filtered.forEach(opt => select.appendChild(opt));
    if (filtered.length === 0) {
      const noResult = new Option('-- Aucun r√©sultat --', '');
      noResult.disabled = true;
      select.add(noResult);
    }
  });

  statutField.addEventListener('change', () => {
    afficherChamps();
    updateDocumentsForStatut();
  });

  afficherChamps();
  updateDocumentsForStatut();
});
</script>
