{% load widget_tweaks %}
<form method="post" enctype="multipart/form-data" novalidate>
  {% csrf_token %}

  <!-- Statut -->
  <div class="row mb-3">
    <label for="id_statut" class="col-sm-2 col-form-label">Statut</label>
    <div class="col-sm-10">
      {{ form.statut|add_class:"form-select" }}
      {% for error in form.statut.errors %}
        <div class="text-danger small">‚ö†Ô∏è {{ error }}</div>
      {% endfor %}
    </div>
  </div>
 
   <!-- Date de l'√©v√©nement -->
  <div class="row mb-3" id="id_date_evenement_section">
    <label for="id_date_evenement" class="col-sm-2 col-form-label">Date de l'√©v√©nement</label>
    <div class="col-sm-10">
      <div class="input-group input-group-merge">
        <span class="input-group-text"><i class="bx bx-calendar"></i></span>
        {{ form.date_evenement|add_class:"form-control" | attr:"placeholder=JJ/MM/AAAA" }}
      </div>
    </div>
  </div>

  <!-- Recherche √âtudiant -->
  <div class="row mb-3">
    <label for="searchEtudiants" class="col-sm-2 col-form-label">Rechercher un √©tudiant (matricule)</label>
    <div class="col-sm-10">
      <div class="input-group input-group-merge">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" id="searchEtudiants" class="form-control" placeholder="Entrer un matricule...">
      </div>
    </div>
  </div>

  <!-- √âtudiant -->
  <div class="row mb-3" id="id_etudiant_section">
    <label for="id_etudiant" class="col-sm-2 col-form-label">√âtudiant</label>
    <div class="col-sm-10">
      {{ form.etudiant|add_class:"form-select" }}
      {% for error in form.etudiant.errors %}
        <div class="text-danger small">‚ö†Ô∏è {{ error }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- Ann√©e acad√©mique -->
  <div class="row mb-3" id="id_annee_section">
    <label for="id_annee_academique" class="col-sm-2 col-form-label">Ann√©e acad√©mique</label>
    <div class="col-sm-10">
      {{ form.annee_academique|add_class:"form-select" }}
      {% for error in form.annee_academique.errors %}
        <div class="text-danger small">‚ö†Ô∏è {{ error }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- Parcours -->
  <div class="row mb-3" id="id_parcours_section">
    <label for="id_parcours" class="col-sm-2 col-form-label">Parcours</label>
    <div class="col-sm-10">
      {{ form.parcours|add_class:"form-select" }}
      {% for error in form.parcours.errors %}
        <div class="text-danger small">‚ö†Ô∏è {{ error }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- Classe -->
  <div class="row mb-3" id="id_classe_section">
    <label for="id_classe" class="col-sm-2 col-form-label">Classe</label>
    <div class="col-sm-10">
      {{ form.classe|add_class:"form-select" }}
      {% for error in form.classe.errors %}
        <div class="text-danger small">‚ö†Ô∏è {{ error }}</div>
      {% endfor %}
    </div>
  </div>

  <!-- R√©sultat ann√©e pr√©c√©dente -->
  <div class="row mb-3" id="id_resultat_section">
    <label for="id_resultat_annee_precedente" class="col-sm-2 col-form-label">R√©sultat ann√©e pr√©c√©dente</label>
    <div class="col-sm-10">
      <div class="input-group input-group-merge">
        <span class="input-group-text"><i class="bx bx-check-circle"></i></span>
        {{ form.resultat_annee_precedente|add_class:"form-control" }}
      </div>
    </div>
  </div>

  <!-- Motif -->
  <div class="row mb-3" id="id_motif_section">
    <label for="id_motif" class="col-sm-2 col-form-label">Motif</label>
    <div class="col-sm-10">
      <div class="input-group input-group-merge">
        <span class="input-group-text"><i class="bx bx-info-circle"></i></span>
        {{ form.motif|add_class:"form-control" }}
      </div>
    </div>
  </div>

  <!-- Dur√©e -->
  <div class="row mb-3" id="id_duree_section">
    <label for="id_duree" class="col-sm-2 col-form-label">Dur√©e (en jours)</label>
    <div class="col-sm-10">
      <div class="input-group input-group-merge">
        <span class="input-group-text"><i class="bx bx-timer"></i></span>
        {{ form.duree|add_class:"form-control" }}
      </div>
    </div>
  </div>

  <!-- √âtablissement d‚Äôaccueil -->
  <div class="row mb-3" id="id_etablissement_section">
    <label for="id_Etablissement_accuiel" class="col-sm-2 col-form-label">√âtablissement d‚Äôaccueil</label>
    <div class="col-sm-10">
      <div class="input-group input-group-merge">
        <span class="input-group-text"><i class="bx bx-building"></i></span>
        {{ form.Etablissement_accuiel|add_class:"form-control" }}
      </div>
    </div>
  </div>

  <!-- Documents -->
  <div class="mb-3" id="documents-section">
    <h5 class="mb-3 fw-semibold">üìé Documents √† fournir</h5>
    {{ formset.management_form }}
    {% for doc_form in formset %}
      <div class="doc-block row mb-3 border rounded p-3" data-doc-type="{{ doc_form.type_document.value|default_if_none:'' }}">
        <div class="col-md-6">
          <label class="form-label">Type de document</label>
          {{ doc_form.type_document|add_class:"form-select" }}
        </div>
        <div class="col-md-6">
          <label class="form-label">Fichier</label>
          {{ doc_form.fichier|add_class:"form-control" }}
        </div>
        {% if doc_form.DELETE %}
        <div class="col-12 mt-2">
          <label>{{ doc_form.DELETE }} Supprimer ce document</label>
        </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- Bouton de soumission -->
  <div class="text-center mt-4">
    <button type="submit" class="btn btn-primary">Enregistrer</button>
  </div>
</form>

<!-- Scripts -->

<!-- Recherche √©tudiant par matricule -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const input = document.getElementById('searchEtudiants');
  const select = document.getElementById('id_etudiant');
  const options = Array.from(select.options);

  input.addEventListener('input', function () {
    const query = this.value.toLowerCase();
    select.innerHTML = '';
    const filtered = options.filter(opt => opt.text.toLowerCase().includes(query));
    filtered.forEach(opt => select.appendChild(opt));
    if (filtered.length === 0) {
      const noOption = new Option('-- Aucun r√©sultat --', '');
      noOption.disabled = true;
      select.add(noOption);
    }
  });
});
</script>

<!-- Affichage dynamique des champs selon statut -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const statut = document.getElementById('id_statut');

  const fieldsMap = {
    parcours: 'id_parcours_section',
    annee: 'id_annee_section',
    classe: 'id_classe_section',
    resultat: 'id_resultat_section',
    motif: 'id_motif_section',
    evenement: 'id_date_evenement_section',
    duree: 'id_duree_section',
    etab: 'id_etablissement_section',
    documents: 'documents-section'
  };

  function hideAllFields() {
    for (const key in fieldsMap) {
      const el = document.getElementById(fieldsMap[key]);
      if (el) el.style.display = 'none';
    }
  }

  function showFields(keys) {
    keys.forEach(key => {
      const el = document.getElementById(fieldsMap[key]);
      if (el) el.style.display = 'flex';
    });
  }

  function updateFields() {
    hideAllFields();
    const val = statut.value;
    switch(val) {
      case 'reinscrit':
      case 'redoublant':
        showFields(['evenement','parcours', 'annee', 'classe', 'resultat']);
        break;
      case 'abandon':
      case 'exclu':
        showFields(['evenement','motif', 'evenement']);
        break;
      case 'suspendu':
        showFields([ 'motif', 'evenement', 'duree']);
        break;
      case 'en_attente':
      case 'reserviste':
        showFields(['documents']);
        break;
      case 'transfert':
        showFields(['etab', 'motif', 'evenement']);
        break;
      case 'diplome':
        showFields(['resultat']);
        break;
      default:
        // Par d√©faut afficher juste l'ann√©e
        showFields(['annee']);
        break;
    }
  }

  statut.addEventListener('change', updateFields);
  updateFields();
});
</script>

<!-- Filtrage documents selon statut -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const statutField = document.getElementById("id_statut");

  const documentsParStatut = {
    reinscrit: ['formulaire', 'frais'],
    abandon: [],
    suspendu: [],
    exclu: [],
    en_attente: ['formulaire', 'naissance', 'cni', 'parent_identite'],
    transfert: [],
    diplome: [],
    redoublant: ['formulaire'],
    reserviste: ['formulaire', 'diplome', 'bulletin']
  };

  function filtrerDocuments() {
    const selectedStatut = statutField.value;
    const docsVisibles = documentsParStatut[selectedStatut] || [];

    document.querySelectorAll('.doc-block').forEach(block => {
      const docType = block.getAttribute('data-doc-type');
      block.style.display = docsVisibles.includes(docType) ? 'flex' : 'none';
    });
  }

  statutField.addEventListener('change', filtrerDocuments);
  filtrerDocuments();
});
</script>
