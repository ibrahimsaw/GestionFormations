{% load static %}

<div class="bg-primary py-3 px-4 rounded mb-4">
  <h5 class="mb-0 text-center text-white">
    Informations {{ role_utilisateur }}
  </h5>
</div>

<!-- Barre de recherche -->
<div class="input-group mb-3">
  <span class="input-group-text bg-light">
    <i class="bi bi-search"></i>
  </span>
  <label for="searchEtudiants"></label>
  <input
    type="text"
    class="form-control"
    id="searchEtudiants"
    placeholder="Rechercher par matricule, nom ou prénom..."
  />
</div>

<!-- Tout sélectionner / désélectionner -->
<div class="form-check mb-3">
  <input class="form-check-input" type="checkbox" id="selectAllEtudiants" />
  <label class="form-check-label" for="selectAllEtudiants">
    Tout sélectionner / Désélectionner
  </label>
</div>

<!-- Éléments sélectionnés -->
<h5 class="section-title" id="selectedTitle">Enfants sélectionnés</h5>
<ul class="list-group mb-3" id="selectedList"></ul>

<!-- Résultats filtrés -->
<h5 class="section-title" id="etudiantsTitle">Enfants disponibles</h5>
<!-- Conteneur scrollable pour les étudiants disponibles -->
<div class="overflow-auto border rounded p-2 mb-3" style="max-height: 400px;">
<ul class="list-group list-group-flush" id="etudiantsList">
  {% for etudiant in etudiants %}
  <li class="list-group-item border rounded shadow-sm mb-2">
    <div class="d-flex align-items-center gap-1 w-100">
      <input
        type="checkbox"
        class="form-check-input me-2 mt-1"
        name="enfants"
        value="{{ etudiant.utilisateur.id }}"
        id="etudiant-{{ etudiant.utilisateur.id }}"
        {% if etudiant in form.instance.enfants.all %}checked{% endif %}
      />
      <div class="position-relative w-100 d-flex align-items-center gap-1">
        <img
          src="{% if etudiant.utilisateur.photo %}{{ etudiant.utilisateur.photo.url }}{% else %}{% static 'assets/img/avatars/1.png' %}{% endif %}"
          alt="Photo de {{ etudiant.utilisateur.first_name }}"
          class="rounded-circle"
          style="width: 60px; height: 60px"
        />
        <div class="flex-grow-1">
          <strong>{{ etudiant.utilisateur.last_name }} {{ etudiant.utilisateur.first_name }}</strong><br />
          <small>{{ etudiant.utilisateur.matricule }} | {{ etudiant.utilisateur.email }}</small>
          {% if etudiant.classe_actuelle %}
            {% if etudiant.classe_actuelle.nom|length > 20 %}
            <div class="mt-1">
              <span class="badge bg-warning text-dark">{{ etudiant.classe_actuelle.nom }}</span>
            </div>
            {% else %}
            <span
              class="badge bg-warning text-dark position-absolute end-0 top-50 translate-middle-y"
              style="transform: translateY(-50%) rotate(90deg); transform-origin: center;"
            >{{ etudiant.classe_actuelle.nom }}</span>
            {% endif %}
          {% else %}
            <div class="mt-1">
              <span class="badge bg-secondary text-white">Niveau non défini</span>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </li>
  {% endfor %}
  {% if not etudiants %}
  <div class="alert alert-warning">
    Aucun étudiant disponible pour association.
  </div>
  {% endif %}
</ul>
</div>

<!-- Champ caché pour stocker les sélections -->
<input type="hidden" name="enfants_json" id="enfantsJson" value="" />

<!-- Script JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const searchInput = document.getElementById("searchEtudiants");
  const selectedList = document.getElementById("selectedList");
  const etudiantsList = document.getElementById("etudiantsList");
  const selectAllCheckbox = document.getElementById("selectAllEtudiants");
  const enfantsJsonInput = document.getElementById("enfantsJson");

  // Récupérer tous les étudiants à partir des li existants
  const etudiants = Array.from(etudiantsList.querySelectorAll("li")).map(li => {
    const checkbox = li.querySelector("input[type=checkbox]");
    const nomPrenom = li.querySelector("strong").textContent.trim();
    const matriculeEmail = li.querySelector("small").textContent.trim();
    const photo = li.querySelector("img").src;
    const classe = li.querySelector(".badge").textContent.trim();
    return {
      li: li,
      checkbox: checkbox,
      nomPrenom: nomPrenom,
      matriculeEmail: matriculeEmail,
      photo: photo,
      classe: classe,
      selected: checkbox.checked
    };
  });

  function render() {
    selectedList.innerHTML = "";
    etudiantsList.innerHTML = "";

    const filter = searchInput.value.toLowerCase().trim();
    let selectedCount = 0;

    etudiants.forEach(e => {
      const text = (e.nomPrenom + " " + e.matriculeEmail).toLowerCase();
      if (!text.includes(filter)) return;

      e.checkbox.checked = e.selected; // synchro checkbox

      if (e.selected) {
        selectedList.appendChild(e.li);
        selectedCount++;
      } else {
        etudiantsList.appendChild(e.li);
      }
    });

    // Tout sélectionner / désélectionner
    selectAllCheckbox.checked = selectedCount === etudiants.length;
    selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < etudiants.length;

    // Mise à jour champ caché
    enfantsJsonInput.value = JSON.stringify(etudiants.filter(e => e.selected).map(e => e.checkbox.value));
  }

  // Gestion click sur chaque checkbox
  etudiants.forEach(e => {
    e.checkbox.addEventListener("change", () => {
      e.selected = e.checkbox.checked;
      render();
    });
  });

  // Recherche
  searchInput.addEventListener("input", () => {
    render();
  });

  // Tout sélectionner / désélectionner
  selectAllCheckbox.addEventListener("change", () => {
    const check = selectAllCheckbox.checked;
    etudiants.forEach(e => e.selected = check);
    render();
  });

  render(); // rendu initial
});
</script>
