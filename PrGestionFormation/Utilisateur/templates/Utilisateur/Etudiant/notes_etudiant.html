{% extends 'Accuiel/Etudiant/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block contentetudiant %}

<div class="tab-pane fade show active" id="grades">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>
                Notes et Résultats
            </h3>
        </div>
        <div class="card-body">
            <!-- Infos générales -->
            <div class="mb-3" id="student-summary">
                <!-- Rempli par JS -->
            </div>

            <!-- Moyenne générale -->
            <div class="alert alert-success mb-3" id="overall-grade">
                <!-- Rempli par JS -->
            </div>

            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Matière</th>
                            <th>Professeur</th>
                            <th>Coeff</th>
                            <th>Note</th>
                            <th class="d-none d-md-table-cell">Moy. Classe</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody id="grades-table">
                        <!-- Rempli par JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// =======================
// Données de l'étudiant
// =======================
const studentData = {
    name: "Jean Dupont",
    rank: 5, // Rang dans la classe
    totalSubjects: 18, // total matières
    validatedSubjects: 15,
    failedSubjects: 3,
    trimesters: [
        {
            name: "1er Trimestre",
            average: 13.5,
            mention: "Assez Bien",
            subjects: [
                { name: "Mathématiques", coeff: 3, grade: 14, classAvg: 12.5, professor: "Prof. Moreau", status: "Validé" },
                { name: "Algorithmes", coeff: 4, grade: 12, classAvg: 11.0, professor: "Prof. Leroy", status: "Validé" },
                { name: "Physique", coeff: 3, grade: 15, classAvg: 13.2, professor: "Prof. Bernard", status: "Validé" },
            ]
        },
        {
            name: "2e Trimestre",
            average: 14.8,
            mention: "Bien",
            subjects: [
                { name: "Mathématiques", coeff: 3, grade: 16, classAvg: 13.2, professor: "Prof. Moreau", status: "Validé" },
                { name: "Algorithmes", coeff: 4, grade: 14, classAvg: 12.3, professor: "Prof. Leroy", status: "Validé" },
                { name: "Physique", coeff: 3, grade: 15, classAvg: 12.8, professor: "Prof. Bernard", status: "Validé" },
            ]
        },
        {
            name: "3e Trimestre",
            average: 15.7,
            mention: "Très Bien",
            subjects: [
                { name: "Mathématiques", coeff: 3, grade: 18, classAvg: 14.5, professor: "Prof. Moreau", status: "Validé" },
                { name: "Algorithmes", coeff: 4, grade: 15, classAvg: 13.5, professor: "Prof. Leroy", status: "Validé" },
                { name: "Physique", coeff: 3, grade: 14, classAvg: 12.9, professor: "Prof. Bernard", status: "Validé" },
            ]
        }
    ]
};

// Calcul automatique de la moyenne générale
studentData.globalAverage = Number(
    (studentData.trimesters.reduce((sum, t) => sum + t.average, 0) / studentData.trimesters.length).toFixed(2)
);

// =======================
// Génération du tableau
// =======================
function generateGradesTable() {
    const summaryDiv = document.getElementById('student-summary');
    const overallGradeDiv = document.getElementById('overall-grade');
    const gradesTable = document.getElementById('grades-table');

    // Infos générales
    summaryDiv.innerHTML = `
        <p><strong>Étudiant:</strong> ${studentData.name}</p>
        <p><strong>Rang dans la classe:</strong> ${studentData.rank}</p>
        <p><strong>Matières validées:</strong> ${studentData.validatedSubjects} / ${studentData.totalSubjects}</p>
        <p><strong>Matières à rattraper:</strong> ${studentData.failedSubjects}</p>
    `;

    // Moyenne générale
    overallGradeDiv.innerHTML = `
        <h5><i class="fas fa-trophy me-2"></i>Moyenne Générale Année: 
        <strong>${studentData.globalAverage}/20</strong></h5>
    `;

    gradesTable.innerHTML = '';

    studentData.trimesters.forEach(trimester => {
        // Ligne titre du trimestre
        const titleRow = document.createElement('tr');
        titleRow.innerHTML = `<td colspan="6" class="table-primary fw-bold">${trimester.name} — Moyenne: ${trimester.average}/20 (${trimester.mention})</td>`;
        gradesTable.appendChild(titleRow);

        // Matières du trimestre
        trimester.subjects.forEach(subject => {
            const row = document.createElement('tr');
            const gradeClass = subject.grade >= 15 ? 'text-success' : subject.grade >= 12 ? 'text-warning' : 'text-danger';
            const statusClass = subject.status === 'Validé' ? 'bg-success' : 'bg-danger';

            row.innerHTML = `
                <td>${subject.name}</td>
                <td>${subject.professor}</td>
                <td><span class="badge bg-primary">${subject.coeff}</span></td>
                <td><span class="${gradeClass} fw-bold">${subject.grade}/20</span></td>
                <td class="d-none d-md-table-cell">${subject.classAvg}/20</td>
                <td><span class="badge ${statusClass}">${subject.status}</span></td>
            `;
            gradesTable.appendChild(row);
        });
    });
}

// Initialisation
document.addEventListener('DOMContentLoaded', generateGradesTable);

</script>

{% endblock %}
