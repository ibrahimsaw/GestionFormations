{% extends 'base.html' %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between">
<h6 class="text-muted">{{ titre_page }}</h6>
<nav aria-label="breadcrumb" class="d-none d-sm-block">
	 <ol class="breadcrumb">
	   {% for item in breadcrumb %}
		 {% if item.is_last %}
		   <li class="breadcrumb-item active" aria-current="page">{{ item.name }}</li>
		 {% elif item.is_first %}
		   <li class="breadcrumb-item">{{ item.name }} </li>
		 {% else %}
		   <li class="breadcrumb-item"><a href="{{ item.url }}">{{ item.name }}</a></li>
		 {% endif %}
	   {% endfor %}
	 </ol>
 </nav>
</div>

<div class="card shadow-sm border-0">
    <div class="card-body">
      {% if model_type == 'parcours' %}
	 	<div class="text-center">
		  <div class="alert bg-primary">
			<h5 class="mb-0 text-white">Parcours : {{ parcours.nom }}</h5>
		  </div>
		</div>
        <div class="row g-3 mb-4">
          {% if parcours.type_formation.nom %}
            <div class="col-12 col-sm-6">
              <div class="p-3 bg-light rounded border">
                <strong>Type de formation :</strong> {{ parcours.type_formation.nom }}
              </div>
            </div>
          {% endif %}
          {% if parcours.specification.nom %}
            <div class="col-12 col-sm-6">
              <div class="p-3 bg-light rounded border">
                <strong>Spécification :</strong> {{ parcours.specification.nom }}
              </div>
            </div>
          {% endif %}
          {% if parcours.code_serie %}
            <div class="col-12 col-sm-6">
              <div class="p-3 bg-light rounded border">
                <strong>Code série :</strong> {{ parcours.code_serie|default:"N/A" }}
              </div>
            </div>
          {% endif %}
          {% if parcours.diplome_final %}
            <div class="col-12 col-sm-6">
              <div class="p-3 bg-light rounded border">
                <strong>Diplôme final :</strong> {{ parcours.diplome_final|default:"-" }}
              </div>
            </div>
          {% endif %}
        </div>

        {% if parcours.structure_classes %}
          <div class="mb-4">
            <h5 class="mb-2 fw-semibold">Structure des classes</h5>
            <ul class="list-group">
              {% for classe in parcours.structure_classes %}
                <li class="list-group-item small">{{ classe }}</li>
              {% empty %}
                <li class="list-group-item text-muted">Aucune classe définie.</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% for formation_data in formations_et_classes %}
          <div class="mb-5">
            <h5 class="fw-semibold border-bottom pb-1">Formation : {{ formation_data.formation.nom }}</h5>
            {% for annee_data in formation_data.classes_par_annee %}
              <div class="ms-md-3 mb-4">
                <div class="d-flex flex-column flex-md-row justify-content-between">
                  <div>
                    <strong>Année académique :</strong>
                    <a href="{% url 'formation:universal-detail' 'annee' 1 %}" class="text-decoration-none">{{ annee_data.annee }}</a>
                  </div>
                  <div><strong>Total étudiants :</strong> {{ annee_data.nb_etudiants_annee }}</div>
                </div>
                <ul class="list-group mt-2">
                  {% for classe_info in annee_data.classes %}
                    <li class="list-group-item d-flex flex-column flex-sm-row justify-content-between align-items-start">
                      <div>
                        Classe :
                        <a href="{% url 'formation:universal-detail' 'classe' classe_info.classe.pk %}" class="text-decoration-none">{{ classe_info.classe.nom }}</a>
                      </div>
                      <span>{{ classe_info.nb_etudiants }} étudiant(s)</span>
                    </li>
                  {% endfor %}
                </ul>
              </div>
            {% endfor %}
          </div>
        {% endfor %}

      {% elif model_type == 'formation' %}
	 <div class="text-center">
		  <div class="alert bg-primary">
			<h5 class="mb-0 text-white">Formation : {{ obj }}</h5>
		  </div>
		</div>
        <p>Parcours : {{ obj.parcours }}</p>

        {% for groupe in classes %}
          <div class="mb-3">
            <h6 class="fw-semibold">Année : {{ groupe.annee }}</h6>
            <ul class="list-group">
              {% for item in groupe.classes %}
                <li class="list-group-item d-flex flex-column flex-sm-row justify-content-between">
                  <span>
                    Classe :
                    <a href="{% url 'formation:universal-detail' 'classe' item.classe.pk %}" class="text-decoration-none">{{ item.classe.nom }}</a>
                  </span>
                  <span>{{ item.nb_etudiants }} étudiant(s)</span>
                </li>
              {% empty %}
                <li class="list-group-item">Aucune classe.</li>
              {% endfor %}
            </ul>
          </div>
        {% endfor %}

      {% elif model_type == 'annee' %}
	 <div class="text-center">
		  <div class="alert bg-primary">
			<h5 class="mb-0 text-white">Année académique : {{ annee }}</h5>
		  </div>
		</div>
        <p>Total étudiants : {{ nb_etudiants_total }}</p>

        {% for bloc in formations_et_classes %}
          <div class="my-3">
            <h6 class="fw-semibold">Formation :
              <a href="{% url 'formation:universal-detail' 'formation' bloc.formation.pk %}" class="text-decoration-none">{{ bloc.formation }}</a>
            </h6>
            <ul class="list-group">
              {% for info in bloc.classes %}
                <li class="list-group-item d-flex flex-column flex-sm-row justify-content-between">
                  <span>
                    Classe :
                    <a href="{% url 'formation:universal-detail' 'classe' info.classe.pk %}" class="text-decoration-none">{{ info.classe.nom }}</a>
                  </span>
                  <span>{{ info.nb_etudiants }} étudiant(s)</span>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endfor %}

      {% elif model_type == 'classe' %}
	 <div class="text-center">
		  <div class="alert bg-primary">
			<h5 class="mb-0 text-white">Classe : {{ obj.nom }}</h5>
		  </div>
		</div>
        <p>Formation : {{ formation }}</p>
        <p>Parcours : {{ parcours }}</p>
        <p>Année académique : {{ annee }}</p>
        <p>Nombre d'étudiants : {{ nb_etudiants }}</p>

        <div class="table-responsive">
          <table class="table table-bordered">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Matricule</th>
                <th>Naissance</th>
                <th>Email</th>
                <th>Téléphone</th>
              </tr>
            </thead>
            <tbody>
              {% for etu in etudiants %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ etu.utilisateur.last_name }}</td>
                  <td>{{ etu.utilisateur.first_name }}</td>
                  <td>{{ etu.utilisateur.matricule }}</td>
                  <td>{{ etu.utilisateur.date_nais }}</td>
                  <td>{{ etu.utilisateur.email }}</td>
                  <td>{{ etu.utilisateur.telephone }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="7" class="text-center">Aucun étudiant inscrit.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      {% else %}
        <p>Aucune donnée disponible.</p>
      {% endif %}
    </div>
    <div class="card-footer text-end">
      <a href="{% url 'formation:universal-list' 'model_type' %}" class="btn btn-outline-secondary">← Retour</a>
    </div>
  </div>

<div class="fixed-action-buttons">
 	<a href="{% url 'formation:universal-create' model_type %}" class="btn btn-add">
	   <span class="tf-icons bx bx-notepad"></span>&nbsp; Ajouter
   </a>
	<a href="{% url 'formation:universal-list' model_type %}" class="btn btn-list">
		<span class="tf-icons bx bx-list-ul"></span>&nbsp;  Listes
	</a>
</div>
{% endblock %}
